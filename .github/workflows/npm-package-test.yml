name: NPM Package Test

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to test (e.g., "latest", "0.6.0", "next")'
        required: false
        default: 'latest'
        type: string

jobs:
  test-npm-package:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create test project
        run: |
          mkdir test-project
          cd test-project
          git init
          npm init -y
          mkdir -p .claude

      - name: Determine package version
        id: version
        run: |
          VERSION="${{ inputs.version || 'latest' }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing claude-ketchup@$VERSION"

      - name: Install claude-ketchup via npx
        working-directory: test-project
        run: |
          echo "Installing claude-ketchup@${{ steps.version.outputs.version }}..."
          npx claude-ketchup@${{ steps.version.outputs.version }} install

      - name: Verify package in devDependencies
        working-directory: test-project
        run: |
          echo "=== package.json ==="
          cat package.json
          echo ""
          echo "Checking devDependencies..."
          node -e "const pkg = require('./package.json'); if (!pkg.devDependencies?.['claude-ketchup']) { console.error('claude-ketchup not in devDependencies'); process.exit(1); } console.log('Found claude-ketchup@' + pkg.devDependencies['claude-ketchup']);"

      - name: Run status command (using local install)
        working-directory: test-project
        run: |
          echo "Running status command..."
          npx claude-ketchup status

      - name: Run doctor command (using local install)
        working-directory: test-project
        run: |
          echo "Running doctor command..."
          npx claude-ketchup doctor

      - name: Run reminders command (using local install)
        working-directory: test-project
        run: |
          echo "Running reminders command..."
          npx claude-ketchup reminders

      - name: Verify installation structure
        working-directory: test-project
        run: |
          echo "=== Directory structure ==="
          ls -la
          echo ""
          echo "=== .claude directory ==="
          ls -la .claude/ || echo "No .claude directory"
          echo ""
          echo "=== .ketchup directory ==="
          ls -la .ketchup/ || echo "No .ketchup directory"
          echo ""
          echo "=== Symlink verification ==="
          find . -type l -exec ls -la {} \; 2>/dev/null || echo "No symlinks found"

      - name: Test repair command (using local install)
        working-directory: test-project
        run: |
          echo "Running repair command..."
          npx claude-ketchup repair

      - name: Final doctor check (using local install)
        working-directory: test-project
        run: |
          echo "Final doctor check after repair..."
          npx claude-ketchup doctor
