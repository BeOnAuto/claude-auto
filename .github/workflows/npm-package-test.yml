name: NPM Package Test

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to test (e.g., "latest", "0.6.0", "next")'
        required: false
        default: 'latest'
        type: string

jobs:
  test-npm-package:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create test project
        run: |
          mkdir test-project
          cd test-project
          git init
          npm init -y
          mkdir -p .claude

      - name: Determine package version
        id: version
        run: |
          VERSION="${{ inputs.version || 'latest' }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing @xolvio/claude-ketchup@$VERSION"

      - name: Install claude-ketchup via npx
        working-directory: test-project
        run: |
          echo "Installing @xolvio/claude-ketchup@${{ steps.version.outputs.version }}..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} install

      - name: Run status command
        working-directory: test-project
        run: |
          echo "Running status command..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} status

      - name: Run doctor command
        working-directory: test-project
        run: |
          echo "Running doctor command..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} doctor

      - name: Run reminders command
        working-directory: test-project
        run: |
          echo "Running reminders command..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} reminders

      - name: Verify installation structure
        working-directory: test-project
        run: |
          echo "=== Directory structure ==="
          ls -la
          echo ""
          echo "=== .claude directory ==="
          ls -la .claude/ || echo "No .claude directory"
          echo ""
          echo "=== .ketchup directory ==="
          ls -la .ketchup/ || echo "No .ketchup directory"
          echo ""
          echo "=== Symlink verification ==="
          find . -type l -exec ls -la {} \; 2>/dev/null || echo "No symlinks found"

      - name: Test repair command
        working-directory: test-project
        run: |
          echo "Running repair command..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} repair

      - name: Final doctor check
        working-directory: test-project
        run: |
          echo "Final doctor check after repair..."
          npx @xolvio/claude-ketchup@${{ steps.version.outputs.version }} doctor
